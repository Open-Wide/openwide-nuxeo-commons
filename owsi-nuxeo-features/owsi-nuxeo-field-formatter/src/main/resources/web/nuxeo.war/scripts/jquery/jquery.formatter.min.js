!function($,window,document,undefined){var defaults={persistent:false,repeat:false,placeholder:" "};var inptRegs={9:/[0-9]/,a:/[A-Za-z]/,"*":/[A-Za-z0-9]/};function Formatter(el,opts){var self=this;self.el=el;if(!self.el){throw new TypeError("Must provide an existing element")}self.opts=utils.extend({},defaults,opts);if(typeof self.opts.pattern==="undefined"){throw new TypeError("Must provide a pattern")}var parsed=pattern.parse(self.opts.pattern);self.mLength=parsed.mLength;self.chars=parsed.chars;self.inpts=parsed.inpts;self.hldrs={};self.focus=0;utils.addListener(self.el,"keydown",function(evt){self._keyDown(evt)});utils.addListener(self.el,"keypress",function(evt){self._keyPress(evt)});utils.addListener(self.el,"paste",function(evt){self._paste(evt)});if(self.opts.persistent){self._processKey("",false);self.el.blur();utils.addListener(self.el,"focus",function(evt){self._focus(evt)});utils.addListener(self.el,"click",function(evt){self._focus(evt)});utils.addListener(self.el,"touchstart",function(evt){self._focus(evt)})}}Formatter.prototype.resetPattern=function(str){this.opts.pattern=str;this.sel=inptSel.get(this.el);this.val=this.el.value;this.delta=0;this._removeChars();var parsed=pattern.parse(str);this.mLength=parsed.mLength;this.chars=parsed.chars;this.inpts=parsed.inpts;this._processKey("",false)};Formatter.prototype._keyDown=function(evt){var k=evt.which||evt.keyCode;if(k&&utils.isDelKey(k)){this._processKey(null,k);return utils.preventDefault(evt)}};Formatter.prototype._keyPress=function(evt){var k,isSpecial;if(evt.which){k=evt.which}else{k=evt.keyCode;isSpecial=utils.isSpecialKey(k)}if(!utils.isDelKey(k)&&!isSpecial&&!utils.isModifier(evt)){this._processKey(String.fromCharCode(k),false);return utils.preventDefault(evt)}};Formatter.prototype._paste=function(evt){this._processKey(utils.getClip(evt),false);return utils.preventDefault(evt)};Formatter.prototype._focus=function(evt){var self=this;setTimeout(function(){var selection=inptSel.get(self.el);var isAfterStart=selection.end>self.focus;isFirstChar=selection.end===0;if(isAfterStart||isFirstChar){inptSel.set(self.el,self.focus)}},0)};Formatter.prototype._processKey=function(chars,delKey){this.sel=inptSel.get(this.el);this.val=this.el.value;this.delta=0;if(this.sel.begin!==this.sel.end){this.delta=-1*Math.abs(this.sel.begin-this.sel.end);this.val=utils.removeChars(this.val,this.sel.begin,this.sel.end)}else if(delKey&&delKey==46){this._delete()}else if(delKey&&this.sel.begin-1>=0){this.val=utils.removeChars(this.val,this.sel.end-1,this.sel.end);this.delta=-1}else if(delKey){return true}if(!delKey){this.val=utils.addChars(this.val,chars,this.sel.begin);this.delta+=chars.length}this._formatValue()};Formatter.prototype._delete=function(){while(this.chars[this.sel.begin]){this._nextPos()}if(this.sel.begin<this.val.length){this._nextPos();this.val=utils.removeChars(this.val,this.sel.end-1,this.sel.end);this.delta=-1}};Formatter.prototype._nextPos=function(){this.sel.end++;this.sel.begin++};Formatter.prototype._formatValue=function(){this.newPos=this.sel.end+this.delta;this._removeChars();this._validateInpts();this._addChars();this.el.value=this.val.substr(0,this.mLength);inptSel.set(this.el,this.newPos)};Formatter.prototype._removeChars=function(){if(this.sel.end>this.focus){this.delta+=this.sel.end-this.focus}var shift=0;for(var i=0;i<=this.mLength;i++){var curChar=this.chars[i],curHldr=this.hldrs[i],pos=i+shift,val;pos=i>=this.sel.begin?pos+this.delta:pos;val=this.val.charAt(pos);if(curChar&&curChar==val||curHldr&&curHldr==val){this.val=utils.removeChars(this.val,pos,pos+1);shift--}}this.hldrs={};this.focus=this.val.length};Formatter.prototype._validateInpts=function(){for(var i=0;i<this.val.length;i++){var inptType=this.inpts[i];var isBadType=!inptRegs[inptType],isInvalid=!isBadType&&!inptRegs[inptType].test(this.val.charAt(i)),inBounds=this.inpts[i];if((isBadType||isInvalid)&&inBounds){this.val=utils.removeChars(this.val,i,i+1);this.focusStart--;this.newPos--;this.delta--;i--}}};Formatter.prototype._addChars=function(){if(this.opts.persistent){for(var i=0;i<=this.mLength;i++){if(!this.val.charAt(i)){this.val=utils.addChars(this.val,this.opts.placeholder,i);this.hldrs[i]=this.opts.placeholder}this._addChar(i)}while(this.chars[this.focus]){this.focus++}}else{for(var j=0;j<=this.val.length;j++){if(this.delta<=0&&j==this.focus){return true}this._addChar(j)}}};Formatter.prototype._addChar=function(i){var char=this.chars[i];if(!char){return true}if(utils.isBetween(i,[this.sel.begin-1,this.newPos+1])){this.newPos++;this.delta++}if(i<=this.focus){this.focus++}if(this.hldrs[i]){delete this.hldrs[i];this.hldrs[i+1]=this.opts.placeholder}this.val=utils.addChars(this.val,char,i)};var pattern={};var DELIM_SIZE=4;var regexp=new RegExp("{{([^}]+)}}","g");var getMatches=function(pattern){var matches=[],match;while(match=regexp.exec(pattern)){matches.push(match)}return matches};pattern.parse=function(pattern){var info={inpts:{},chars:{}};var matches=getMatches(pattern),pLength=pattern.length;var mCount=0,iCount=0,i=0;var processMatch=function(val){var valLength=val.length;for(var j=0;j<valLength;j++){info.inpts[iCount]=val.charAt(j);iCount++}mCount++;i+=val.length+DELIM_SIZE-1};for(i;i<pLength;i++){if(i==matches[mCount].index){processMatch(matches[mCount][1])}else{info.chars[i-mCount*DELIM_SIZE]=pattern.charAt(i)}}info.mLength=i-mCount*DELIM_SIZE;return info};var inptSel={};inptSel.get=function(el){if(typeof el.selectionStart=="number"){return{begin:el.selectionStart,end:el.selectionEnd}}var range=document.selection.createRange();if(range&&range.parentElement()==el){var inputRange=el.createTextRange(),endRange=el.createTextRange(),length=el.value.length;inputRange.moveToBookmark(range.getBookmark());endRange.collapse(false);if(inputRange.compareEndPoints("StartToEnd",endRange)>-1){return{begin:length,end:length}}return{begin:-inputRange.moveStart("character",-length),end:-inputRange.moveEnd("character",-length)}}return{begin:0,end:0}};inptSel.set=function(el,pos){if(el.setSelectionRange){el.focus();el.setSelectionRange(pos,pos)}else if(el.createTextRange){var range=el.createTextRange();range.collapse(true);range.moveEnd("character",pos);range.moveStart("character",pos);range.select()}};var utils={};var uAgent=typeof navigator!=="undefined"?navigator.userAgent:null,iPhone=/iphone/i.test(uAgent);utils.extend=function(destObj){for(var i=1;i<arguments.length;i++){for(var key in arguments[i]){destObj[key]=arguments[i][key]}}return destObj};utils.addChars=function(str,chars,pos){return str.substr(0,pos)+chars+str.substr(pos,str.length)};utils.removeChars=function(str,start,end){return str.substr(0,start)+str.substr(end,str.length)};utils.isBetween=function(num,bounds){bounds.sort(function(a,b){return a-b});return num>bounds[0]&&num<bounds[1]};utils.addListener=function(el,evt,handler){return typeof el.addEventListener!="undefined"?el.addEventListener(evt,handler,false):el.attachEvent("on"+evt,handler)};utils.preventDefault=function(evt){return evt.preventDefault?evt.preventDefault():evt.returnValue=false};utils.getClip=function(evt){if(evt.clipboardData){return evt.clipboardData.getData("Text")}if(window.clipboardData){return window.clipboardData.getData("Text")}};utils.isDelKey=function(k){return k===8||k===46||iPhone&&k===127};utils.isSpecialKey=function(k){var codes={35:"end",36:"home",37:"leftarrow",38:"uparrow",39:"rightarrow",40:"downarrow"};return codes[k]};utils.isModifier=function(evt){return evt.ctrlKey||evt.altKey||evt.metaKey};var pluginName="formatter";$.fn[pluginName]=function(options){if(typeof options=="object"){this.each(function(){if(!$.data(this,"plugin_"+pluginName)){$.data(this,"plugin_"+pluginName,new Formatter(this,options))}})}this.resetPattern=function(str){this.each(function(){var formatted=$.data(this,"plugin_"+pluginName);if(formatted){formatted.resetPattern(str)}});return this};return this}}(jQuery,window,document);